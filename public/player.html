<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#ffffff" />

  <title>Player - CAH</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="/styles/normalize.css">
  <link rel="stylesheet" href="/styles/init.css">
  <link rel="stylesheet" href="/styles/player.css">
  <link rel="stylesheet" href="/styles/cards.css">
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <div class="container max-w-3xl text-center p-6">
    <!-- Pre-Game Message -->
    <div id="pregame" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold mb-2">Waiting for the Game to Start</h1>
      <p class="mb-4">Please ensure that you have entered the correct link.</p>
      <p class="mb-4">The game will start automatically when the host begins.</p>

      <div class="mt-4">
        <a href="https://github.com/themindstorm/cards-against-humanity" class="text-blue-400 hover:underline">
          GitHub: themindstorm/cards-against-humanity
        </a>
      </div>
    </div>

    <!-- Black Cards Section -->
    <div id="black_card" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 rounded-lg hidden">
      Waiting for the black card...
    </div>

    <!-- White Cards Section -->
    <div id="white_cards" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
  </div>

  <script src="./cards.js"></script>
  <script src="./functions.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let $pregame = document.querySelector('#pregame');
    let $handCards = document.querySelector('#white_cards');
    let $blackCard = document.querySelector('#black_card');
    let selectedCard = null;  // Variable to track if a card has been selected
    let currentCard = null;

    // Shuffle and draw initial hand
    let whiteCards = shuffle(WHITE_CARDS);
    let handCards = whiteCards.splice(0, 5);

    var socket = io();
    let roomID = location.hash.split('#')[1];

    // Join room
    socket.emit('join:room', { roomID: roomID, role: 'player' });

    // Start game event
    socket.on('start_game', (data) => {
      $pregame.style.display = 'none';

      round();
      showElement($blackCard);
    });

    socket.on('blackCard', (data) => {
      $blackCard.innerHTML = data.blackCard; // Show black card
    });

    function round() {
      // Reset the state of the selected card
      selectedCard = null; // Clear selected card
      $handCards.innerHTML = ''; // Clear previous hand of cards

      // Draw new hand of cards (shuffle and get new ones)
      let whiteCards = shuffle(WHITE_CARDS);
      handCards = whiteCards.splice(0, 6);

      // Display cards
      handCards.forEach(card => {
        let cardElement = document.createElement('div');
        cardElement.classList.add('card', 'bg-white', 'text-black', 'p-4', 'rounded-lg', 'cursor-pointer', 'hover:bg-gray-200');
        cardElement.innerHTML = card;
        cardElement.onclick = () => chooseCard(cardElement, escape(card));
        $handCards.appendChild(cardElement);
      });
    }

    function chooseCard(el, card) {
      // Prevent selection if a card is already chosen
      if (selectedCard) return;

      // Mark the card as selected
      selectedCard = el;
      currentCard = card;

      // Send chosen card to server
      socket.emit('card_chosen', { roomID: roomID, card: card });

      // Highlight chosen card and visually indicate it's selected
      el.classList.add('border-4', 'border-red-500', 'opacity-50');  // Make it appear as selected
      el.classList.remove('cursor-pointer'); // Remove cursor pointer to prevent further clicks

      // Optionally, add a message that the card has been selected
      el.innerHTML = `<span class="text-green-500">Card Selected</span><br>${el.innerHTML}`;

      // Disable all other cards
      let cards = document.querySelectorAll('.card');
      cards.forEach(cardEl => {
        if (cardEl !== el) {
          cardEl.classList.add('opacity-50'); // Dim out unselected cards
          cardEl.onclick = null; // Disable further clicks
        }
      });
    }

    // Handle errors
    socket.on('error', (data) => {
      alert(data.message);
    });
  </script>

</body>
</html>
