<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#000000" />

  <title>Host - CAH</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="/styles/normalize.css">
  <link rel="stylesheet" href="/styles/init.css">
  <link rel="stylesheet" href="/styles/host.css">
  <link rel="stylesheet" href="/styles/cards.css">
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <div class="container max-w-3xl text-center p-6">
    
    <!-- Pre-Game Section -->
    <div id="pregame" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h1 class="text-3xl font-bold mb-4">Cards Against Humanity</h1>
      <p class="mb-2">Share this room ID with your friends to join the game:</p>
      <p id="link" class="roomid text-3xl font-bold mb-4">Loading...</p>
      <div class="mt-4 text-lg">
        <span id="players" class="font-bold">0</span> players have joined the game.
      </div>

      <div id="game_starting" class="mt-4 hidden">
        <button id="start_button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md">
          Start Game
        </button>
      </div>

      <div class="mt-4">
        <a href="https://github.com/themindstorm/cards-against-humanity" class="text-blue-400 hover:underline">
          GitHub: themindstorm/cards-against-humanity
        </a>
      </div>
    </div>

    <!-- Black Card Display -->
    <div id="black_card" class="mt-6 text-xl font-bold bg-black text-white p-6 rounded-lg hidden"></div>

    <!-- White Cards Display -->
    <div id="white_cards" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden"></div>

    
    <!-- Scoreboard (Hidden initially) -->
    <div id="scoreboard" class="fixed right-4 top-1/4 w-64 bg-gray-800 p-4 hidden shadow-lg rounded-lg">
      <h2 class="text-xl font-bold text-center mb-4">Scoreboard</h2>
      <ul id="score_list" class="text-white"></ul>
    </div>


    <!-- End of Round Section -->
    <div id="round_end" class="mt-6 hidden">
      <p class="message text-lg">A round has ended. Start another?</p>
      <button id="next_round" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-md mt-2">
        Next Round
      </button>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="./functions.js"></script>
  <script src="./cards.js"></script>
  <script>
    let $pregame = document.querySelector('#pregame');
    let $linkTextarea = document.querySelector('#link');
    let $playerCount = document.querySelector('#players');
    let $gameStarting = document.querySelector('#game_starting');
    let $startGameButton = document.querySelector('#start_button');
    let $scoreList = document.querySelector('#score_list');
    let $scoreboard = document.querySelector('#scoreboard');

    let $blackCard = document.querySelector('#black_card');
    let $whiteCards = document.querySelector('#white_cards');

    let $roundEnd = document.querySelector('#round_end');
    let $nextRoundButton = document.querySelector('#next_round');
    let players = {};
    var playerList = [];

    // shuffle them
    let blackCards = shuffle(BLACK_CARDS);

    // other info
    var noPlayers;
    var whiteCardsReceived = [];
    var whiteCardsPlayer = [];

    var socket = io();
    let roomID = Math.random().toString(36).substring(2);

    let selectedCard = null;

    $linkTextarea.innerText = roomID;

    // joining room
    socket.emit('join:room', {roomID: roomID, role: 'host'});

    socket.on('no_connected', (data) => {
      // incrementing dispaly
      $playerCount.innerText = parseInt($playerCount.innerText) + 1;
      noPlayers = parseInt($playerCount.innerText);
      if (parseInt($playerCount.innerText) == 1) {
        // if there are 1 players, start the game. change to 2 later
        $gameStarting.style.display = 'block';
      }
    })

    socket.on('all_players', (data) => {
      clearPlayerList();
      playerList = [];
      players = {};
      data.players.forEach(player => {
        addPlayer(player.name, player.score);
        playerList.push(player);
      })
    })

    $startGameButton.onclick = () => {
      round();
    }

    // called every round
    function round() {
      $scoreboard.classList.remove('hidden');
      console.log("RoomID: ");
      console.log(roomID);
      socket.emit('start_game', {roomID: roomID}); // alerts players to start round()
      // reset data from previous rounds
      whiteCardsReceived = [];
      whiteCardsPlayer = [];

      hideElement($pregame);
      hideElement($roundEnd);
      // clear white cards from previous round
      showElement($blackCard);
      clearElement($whiteCards);

      let newBlackCard = blackCards.splice(0, 1);
      $blackCard.innerHTML = newBlackCard;
      socket.emit('blackCard', {roomID: roomID, blackCard: newBlackCard});
    }

    socket.on('card_chosen', (data) => {
      whiteCardsReceived.push(data.card);
      whiteCardsPlayer.push(data.player);
      if (whiteCardsReceived.length == noPlayers) {
        for (i=0; i<whiteCardsReceived.length; i++) {
          // whiteCardsRec[i] is already escaped
          $whiteCards.innerHTML += `
            <div id=${whiteCardsPlayer[i]}
              class="card"
              onclick='selectWhiteCard(this, "${whiteCardsReceived[i]}")'
            > ${unescape(whiteCardsReceived[i])}
            <p id=player class=opacity-50>${whiteCardsPlayer[i]} </p>
            </div>
          `;
        }
      }
    })

    function selectWhiteCard(el, card) {
      console.log('Selected ', card);
      console.log("Card ID: ", el.querySelector("#player").innerText);
      // If a card was already selected, remove its selection
      if (selectedCard) {
        selectedCard.classList.remove('border-4', 'border-red-500', 'opacity-50');
      }

      // Set the new selection
      selectedCard = el;
      el.classList.add('border-4', 'border-red-500', 'opacity-50'); // Highlight the selected card

      // Update the black card with the chosen white card text
      let p = $blackCard.innerHTML;
      try{
        let $selected_card_u = document.querySelector('#selected_card');
        $selected_card_u.innerText = unescape(card);
      } catch{
        let n = `${p.split("__")[0]}<i><u id="selected_card">${unescape(card)}</u></i>${p.split("__")[1]}`;
        $blackCard.innerHTML = n;
      }
      showElement($roundEnd);
    }

    $nextRoundButton.onclick = function() {
      console.log('new round');
      //console.log(selectedCard);
      socket.emit('add_point_to', {roomID: roomID, player: selectedCard.querySelector("#player").innerText, points: 1})
      round();
    }

    // Add a player to the scoreboard
    function addPlayer(playerName, points = 0) {
      if (players[playerName]) return; // Prevent duplicates

      players[playerName] = points;

      let li = document.createElement('li');
      li.id = `player-${playerName}`;
      li.textContent = `${playerName}: ${points} Points`;
      li.classList.add('p-2', 'hover:bg-gray-700', 'cursor-pointer');
      $scoreList.appendChild(li);
    }

    // Update a player's score
    function updateScore(playerName, newScore) {
      if (!players[playerName]) return;

      players[playerName] = newScore;
      let li = document.getElementById(`player-${playerName}`);
      if (li) li.textContent = `${playerName}: ${newScore} Points`;
    }

    // Remove a player from the scoreboard
    function removePlayer(playerName) {
      if (!players[playerName]) return;

      delete players[playerName];
      let li = document.getElementById(`player-${playerName}`);
      if (li) li.remove();
    }

    function clearPlayerList() {
      players.forEach(player =>{
        delete players[player.name];
        let li = document.getElementById(`player-${player.name}`);
        if (li) li.remove();
      });
    }

    // Highlight a player (e.g., current judge)
    function highlightPlayer(playerName) {
      document.querySelectorAll('#score_list li').forEach(li => {
        li.classList.remove('bg-yellow-500', 'text-black');
      });

      let li = document.getElementById(`player-${playerName}`);
      if (li) li.classList.add('bg-yellow-500', 'text-black');
  }
  function clearPlayerList() {
      $scoreList.innerHTML = '';
  }
  </script>

</body>
</html>
